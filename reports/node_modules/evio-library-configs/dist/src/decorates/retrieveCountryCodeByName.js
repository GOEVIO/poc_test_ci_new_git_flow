"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.retrieveCountryCodeByName = void 0;
const evio_redis_connection_1 = __importDefault(require("evio-redis-connection"));
const evio_library_connections_1 = __importDefault(require("evio-library-connections"));
const country_schema_1 = require("../schema/country.schema");
let conn;
(async () => {
    conn = await evio_library_connections_1.default.connect('configsDB');
})();
const retrieveCountryCodeByName = async (countryName) => {
    try {
        const cacheKey = `countryCodeByName:${countryName}`;
        let countryCode = await evio_redis_connection_1.default.get(cacheKey);
        if (!countryCode) {
            const country = await evio_library_connections_1.default.findOneDocument(conn.db, 'countries', { countryName: { $regex: `^${countryName}$`, $options: "i" } });
            const countryWrapper = country_schema_1.CountrySchema.safeParse(country);
            if (!countryWrapper.success) {
                console.error("The country is wrong!", countryWrapper.error);
                throw countryWrapper.error;
            }
            countryCode = countryWrapper.data.countryCode;
            await evio_redis_connection_1.default.set(cacheKey, countryCode);
        }
        return countryCode;
    }
    catch (error) {
        throw error;
    }
};
exports.retrieveCountryCodeByName = retrieveCountryCodeByName;
//# sourceMappingURL=retrieveCountryCodeByName.js.map