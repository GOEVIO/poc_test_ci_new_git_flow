"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.getOrDefaultPortugalZone = exports.getFees = exports.retrieveFees = void 0;
const evio_library_connections_1 = __importDefault(require("evio-library-connections"));
const evio_library_commons_1 = require("evio-library-commons");
const fee_repository_1 = require("../repository/fee.repository");
const portugalPostalCode_repository_1 = require("../repository/portugalPostalCode.repository");
const portugalDistrict_repository_1 = require("../repository/portugalDistrict.repository");
let conn;
(async () => {
    conn = await evio_library_connections_1.default.connect(evio_library_commons_1.DBNames.Configs);
})();
const retrieveFees = async () => {
    try {
        return await evio_library_connections_1.default.findDocuments(conn.db, evio_library_commons_1.CollectionNames.Configs.Fees, {});
    }
    catch (error) {
        throw error;
    }
};
exports.retrieveFees = retrieveFees;
const getFees = async (countryCode, zipCode) => {
    const postalCode = zipCode?.split('-')?.[0] ?? '';
    const fee = countryCode !== 'PT'
        ? await fee_repository_1.FeeReadRepository.findOneByCountryCode(countryCode)
        : await fee_repository_1.FeeReadRepository.findOneByCountryCodeAndZone(countryCode, await (0, exports.getOrDefaultPortugalZone)(postalCode));
    return fee;
};
exports.getFees = getFees;
const getOrDefaultPortugalZone = async (zipCode) => {
    if (!zipCode) {
        return 'Portugal';
    }
    const ptPostCode = await portugalPostalCode_repository_1.PortugalPostalCodeReadRepository.findOneByPostalCode(zipCode);
    if (!ptPostCode) {
        return 'Portugal';
    }
    const ptDistrict = await portugalDistrict_repository_1.PortugalDistrictReadRepository.findOneByCode(ptPostCode.districtCode);
    if (!ptDistrict) {
        return 'Portugal';
    }
    return ptDistrict.zone;
};
exports.getOrDefaultPortugalZone = getOrDefaultPortugalZone;
//# sourceMappingURL=fees.js.map